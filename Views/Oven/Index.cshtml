@{
    ViewData["Title"] = "Oven Charts";
}

<div class="container-fluid mt-3 shadow-lg p-4 mb-5 bg-white rounded-3">
    <h2 class="text-black">Oven Charts (Oven Area)</h2>
    <hr class="border border-dark border-1 mb-4 opacity-100">

    <div style="display:flex; align-items:center; gap:25px; margin-bottom:20px;">

        <!-- Oven -->
        <div>
            <label for="OvenSelect">Oven:</label><br>
            <select id="OvenSelect" class="form-select" style="width:200px;">
                <option value="Oven1" selected>Oven1</option>
                <option value="Oven2">Oven2</option>
                <option value="Oven3">Oven3</option>
                <option value="Oven4">Oven4</option>
                <option value="Oven5">Oven5</option>
                <option value="Oven6">Oven6</option>
            </select>
        </div>

        <!-- Shift -->
        <div>
            <label for="shiftSelect">Shift:</label><br>
            <select id="shiftSelect" class="form-select" style="width:200px;">
                <option value="Turno1" selected>Shift 1 (7:00 - 15:00)</option>
                <option value="Turno2">Shift 2 (15:00 - 24:00)</option>
                <option value="Turno3">Shift 3 (00:00 - 7:00)</option>
            </select>
        </div>

        <!-- Date + Button -->
        <div>
            <label for="startDate">Date:</label><br>
            <input type="date" id="startDate" class="form-control" style="width:200px; display:inline-block;">
            <button id="applyFilter" class="btn btn-primary" style="margin-left:10px;">Apply</button>
            <span id="spinner" class="spinner-border spinner-border-sm me-2" style="display:none;"></span>
        </div>

    </div>

    <div style="overflow-x:auto; width: 100%;">
        <canvas id="OvenChart" width="1500" height="300"></canvas>
    </div>

    <!-- Slicer de rango doble -->
    <div style="margin-bottom:80px;">
        <label>Hours Range:</label>
        <div id="rangeSlider" style="width:1800px; margin-top:10px;"></div>
        <span id="rangeValues"></span>
    </div>

    <h2>Oven Paremeters (Real Time)</h2>
    <hr class="border border-dark border-3 mb-4 opacity-100">
    <div id="latestCards" class="row mt-4">
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Pressure</div>
                <div class="card-body">
                    <h5 id="pressureValue" class="card-title">-- bar</h5>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header">Temperature</div>
                <div class="card-body">
                    <h5 id="temperatureValue" class="card-title">-- °C</h5>
                </div>
            </div>
        </div>
       
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- noUiSlider -->
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet" />

    <script>
        var ctx = document.getElementById('OvenChart').getContext('2d');
        var allData = [];

        var OvenChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Pressure', data: [], borderColor: 'rgba(248, 195, 40, 1)', fill: false },
                    { label: 'Temperature', data: [], borderColor: 'rgba(211, 63, 73, 1)', fill: false }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'category',
                        ticks: {
                            callback: function (value) {
                                let label = this.getLabelForValue(value);
                                return label.split(" ")[1];
                            }
                        },
                        title: { display: true, text: 'Hours' }
                    }
                }
            }
        });

        // 👉 Aplicar rango al gráfico
        function applyRange(start, end) {
            let sliced = allData.slice(start, end);

            OvenChart.data.labels = sliced.map(x => x.date + " " + x.time);
            OvenChart.data.datasets[0].data = sliced.map(x => Number(x.press));
            OvenChart.data.datasets[1].data = sliced.map(x => Number(x.temp));

            OvenChart.update();
        }

        // 👉 Inicializar slider
        var rangeSlider = document.getElementById('rangeSlider');
        noUiSlider.create(rangeSlider, {
            start: [0, 100],
            connect: true,
            range: { min: 0, max: 100 },
            step: 1
        });

        rangeSlider.noUiSlider.on('update', function (values) {
            let start = Math.round(values[0]);
            let end = Math.round(values[1]);
            document.getElementById("rangeValues").innerText = start + " - " + end;
            applyRange(start, end);
        });

        // 👉 Cargar datos desde el backend
        function loadData(Date, turno) {
            $("#spinner").show();

            let oven = document.getElementById("OvenSelect").value;

            $.getJSON('/Oven/GetData', { fecha: Date, oven: oven, turno: turno })
                .done(function (data) {
                    allData = data;

                    rangeSlider.noUiSlider.updateOptions({
                        range: { min: 0, max: allData.length },
                        start: [0, allData.length]
                    });

                    applyRange(0, allData.length);

                    if (data.length > 0) {
                        let last = data[data.length - 1];
                        $("#pressureValue").text(last.press + " bar");
                        $("#temperatureValue").text(last.temp + " °C");
                    } else {
                        $("#pressureValue").text("-- bar");
                        $("#temperatureValue").text("-- °C");
                    }
                })
                .always(function () {
                    $("#spinner").hide();
                });
        }

        // 👉 Inicializar con datos de hoy
        var today = new Date().toISOString().substring(0, 10);
        document.getElementById("startDate").value = today;
        loadData(today, "Turno1");

        // 👉 Botón aplicar filtros
        document.getElementById("applyFilter").addEventListener("click", function () {

            let Date = document.getElementById("startDate").value;
            let turno = document.getElementById("shiftSelect").value;

            if (!Date) {
                alert("Debes seleccionar una fecha.");
                return;
            }

            loadData(Date, turno);
        });
    </script>
}
