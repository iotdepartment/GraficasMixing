@{
    ViewData["Title"] = "Oven Charts";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<div class="container-fluid mt-3 shadow-sm p-5 bg-white rounded-4 border-1 border">
    <h2 class="text-end">Primary Oven Charts (Oven Area) <i class="bi bi-clipboard-data"></i></h2>
   <hr class="border border-dark border-0 mb-4 opacity-100">

    <div class="row align-items-end mb-3">

        <!-- Oven -->
        <div class="col-2">
            <label for="OvenSelect">Oven:</label><br>
            <select id="OvenSelect" class="form-select">
                <option value="Oven1" selected>Oven1</option>
                <option value="Oven2">Oven2</option>
                <option value="Oven3">Oven3</option>
                <option value="Oven4">Oven4</option>
                <option value="Oven5">Oven5</option>
                <option value="Oven6">Oven6</option>
            </select>
        </div>
            <div class="col-2">
            <label for="shiftSelect">Shift:</label><br>
            <select id="shiftSelect" class="form-select">
                <option value="Turno1" selected>Shift 1 (7:00 - 15:00)</option>
                <option value="Turno2">Shift 2 (15:00 - 24:00)</option>
                <option value="Turno3">Shift 3 (00:00 - 7:00)</option>
                <option value="All">All shifts</option>
            </select>
        </div>

        <!-- Fecha -->
        <div class="col-2">
            <label for="startDate">Date:</label><br>

            <input type="date" id="startDate" class="form-control">
        </div>

        <!-- Submit button-->
        <div class="col-1 me-0 ">
            <div class="d-grid gap-2">
                <button type="button" id="applyFilter" class="btn btn-primary rounded-pill">
                    Apply
                <span id="spinner" class="spinner-border spinner-border-sm" style="display:none;"></span>
                </button>
            </div>
        </div>

        <!-- Export button-->
            <div class="col-2">
                   <button id="exportChartBtn" class="btn btn-outline-success">
                <i class="bi bi-download"></i> Export Chart
            </button>
        </div>
    </div>

    <!-- Grafica -->
    <div style="overflow-x:auto; width: 100%;">
        <canvas id="OvenChart" width="1500" height="300"></canvas>
    </div>

    <!-- Slicer -->
    <div style="margin-bottom:80px;">
        <label>Hours Range:</label>
            <div id="rangeSlider" style="width:100%; margin-top:10px;"></div>
        <span id="rangeValues"></span>
    </div>
</div>

<!-- Tarjetas -->
<div class="container-fluid mt-3 shadow-sm p-4 mb-5 bg-white rounded-4 border-1 border">
    <div class="row">
        <h2 class="text-start">Primary Oven Parameters (Real Time) <i class="bi bi-clock"></i></h2>
        <div class="text-end mb-2">
            <small id="lastUpdate" class="text-muted">Last update: --</small>
        </div>
    </div>
    <hr class="border border-dark border-0 mb-4 opacity-100">

    <div id="latestCards" class="row mt-4">
        <div class="col-md-6">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Pressure</div>
                <div class="card-body">
                    <h5 id="pressureValue" class="card-title">-- bar</h5>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header">Temperature</div>
                <div class="card-body">
                    <h5 id="temperatureValue" class="card-title">-- °C</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Últimos 10 -->
    <div class="row mt-5">
        <h2 class="text-start">Last 10 Records <i class="bi bi-database"></i></h2>
        <hr class="border border-dark border-0 mb-4 opacity-100">
    </div>

    <div class="table-responsive">
        <table id="last10Table" class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Pressure (bar)</th>
                    <th>Temperature (°C)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet" />

    <script>

        var ctx = document.getElementById('OvenChart').getContext('2d');
        var allData = [];

        var OvenChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Pressure', data: [], borderColor: 'rgba(248,195,40,1)', fill: false },
                    { label: 'Temperature', data: [], borderColor: 'rgba(211,63,73,1)', fill: false }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'category',
                        ticks: {
                            callback: function (value) {
                                let label = this.getLabelForValue(value);
                                let time = label.split(" ")[1] ?? label;
                                return time.substring(0, 5);
                            }
                        },
                        title: { display: true, text: 'Hours' }
                    }
                }
            }
        });

        function applyRange(start, end) {
            let sliced = allData.slice(start, end);

            OvenChart.data.labels = sliced.map(x => x.date + " " + x.time);
            OvenChart.data.datasets[0].data = sliced.map(x => Number(x.press));
            OvenChart.data.datasets[1].data = sliced.map(x => Number(x.temp));

            OvenChart.update();
        }

        var rangeSlider = document.getElementById('rangeSlider');
        noUiSlider.create(rangeSlider, {
            start: [0, 100],
            connect: true,
            range: { min: 0, max: 100 },
            step: 1
        });

        rangeSlider.noUiSlider.on('update', function (values) {
            let start = Math.round(values[0]);
            let end = Math.round(values[1]);
            document.getElementById("rangeValues").innerText = start + " - " + end;
            applyRange(start, end);
        });

              function loadData(date, turno) {
            $("#spinner").show();
            let oven = $("#OvenSelect").val();

            let request;

            if (turno === "All") {
                request = loadAllShifts(date, oven);
            } else {
                request = $.getJSON('/Oven/GetData', { fecha: date, oven: oven, turno: turno })
                           .catch(() => []);
            }

            // Convertimos cualquier cosa en un Promise válido
            Promise.resolve(request)
                .then(data => {
                    allData = data || [];

                    rangeSlider.noUiSlider.updateOptions({
                        range: { min: 0, max: allData.length },
                        start: [0, allData.length]
                    });

                    applyRange(0, allData.length);
                })
                .finally(() => {
                    $("#spinner").hide();
                });
        }

        function loadLatestCards() {
            let oven = $("#OvenSelect").val();

            $.getJSON('/Oven/GetLatest', { oven: oven })
                .done(function (last) {
                    if (last) {
                        $("#pressureValue").text(last.press + " bar");
                        $("#temperatureValue").text(last.temp + " °C");
                    } else {
                        $("#pressureValue").text("-- bar");
                        $("#temperatureValue").text("-- °C");
                    }
                });
        }

        function loadLast10() {
            let oven = $("#OvenSelect").val();

            $.getJSON('/Oven/GetLast10', { oven: oven })
                .done(function (data) {
                    updateLast10Table(data);
                });
        }

        function updateLast10Table(data) {
            let tbody = $("#last10Table tbody");
            tbody.empty();

            data.forEach(item => {
                tbody.append(`
                    <tr>
                        <td>${item.date}</td>
                        <td>${item.time}</td>
                        <td>${item.press}</td>
                        <td>${item.temp}</td>
                    </tr>
                `);
            });
        }

function loadAllShifts(date, oven) {
    const safeGet = turno =>
        $.getJSON('/Oven/GetData', { fecha: date, oven: oven, turno: turno })
         .catch(() => []);

    return Promise.all([
        safeGet("Turno1"),
        safeGet("Turno2"),
        safeGet("Turno3")
    ]).then(([t1, t2, t3]) => {
        let combined = [...t1, ...t2, ...t3];

        combined.sort((a, b) => {
            let d1 = a.date + " " + a.time;
            let d2 = b.date + " " + b.time;
            return d1.localeCompare(d2);
        });

        return combined;
    });
}
        function updateLastUpdateTime() {
            let now = new Date();
            let timeString = now.toLocaleTimeString();
            $("#lastUpdate").text("Last update: " + timeString);
        }

                $("#exportChartBtn").click(() => {
            // Convertir la gráfica a imagen Base64
            const imageURL = OvenChart.toBase64Image();

            // Crear un link temporal para descargarla
            const link = document.createElement('a');
            link.href = imageURL;
            link.download = `OvenChart_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.png`;

            // Ejecutar descarga
            link.click();
        });

        // Inicializar
        var today = new Date().toISOString().substring(0, 10);
        $("#startDate").val(today);

        loadData(today, "Turno1");
        loadLatestCards();
        loadLast10();

        // Filtros
        $("#applyFilter").click(() => {
            let date = $("#startDate").val();
            let turno = $("#shiftSelect").val();
            loadData(date, turno);
        });

        $("#OvenSelect").change(() => {
            loadLatestCards();
            loadLast10();
        });

        // Auto-refresh tarjetas + últimos 10
        setInterval(() => {
            loadLatestCards();
            loadLast10();
            updateLastUpdateTime();

        }, 10000);

    </script>
}