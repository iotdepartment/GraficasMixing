@{
    ViewData["Title"] = "Extruder Efficiency";
}
<div class="container-fluid mt-3 shadow-lg p-4 mb-5 bg-gradient rounded-3">
    <h2 class="text-end">Mesus Charts (Extruder Area) <i class="bi bi-clipboard-data"></i></h2>
    <hr class="border border-dark border-0 mb-4 opacity-100">

    <div class="row align-items-end mb-5">
        <!-- Extruder -->
        <div class="col-2">
            <label for="ExtruderSelect">Extrusora:</label><br>
            <select id="ExtruderSelect" class="form-select">
                @foreach (var extruder in ViewBag.Extruders as List<string>)
                {
                    <option value="@extruder">@extruder</option>
                }
            </select>
        </div>

        <!-- Shift -->
        <div class="col-2">
            <label for="shiftSelect">Turno:</label><br>
            <select id="shiftSelect" class="form-select">
                <option value="Turno1" selected>Turno 1(7:00 - 15:00)</option>
                <option value="Turno2">Turno 2(15:00 - 24:00)</option>
                <option value="Turno3">Turno 3(00:00 - 7:00)</option>
                <option value="All">Todos los Turnos</option>
            </select>
        </div>

        <!-- Fecha -->
        <div class="col-2">
            <label for="startDate">Fecha:</label><br>
            <input type="date" id="startDate" class="form-control">
        </div>

        <!-- Submit button-->
        <div class="col-1 me-0 ">
            <div class="d-grid gap-2">
                <button type="button" id="applyFilter" class="btn btn-primary rounded-pill">
                    Apply
                    <span id="spinner" class="spinner-border spinner-border-sm" style="display:none;"></span>
                </button>
            </div>
        </div>
    </div>

    <div class="row align-items-end mb-5 mt-1">
        <div class="col-4 mb-2">
            <div class="card shadow-sm border-0 rounded-0 h-100">
                <div style="height:360px;">
                    <canvas id="TotmPieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-4 mb-2">
            <div class="card shadow-sm border-0 rounded-0 h-100">
                <div style="height:360px;">
                    <canvas id="EfficiencyBarChart" width="10" height="10"></canvas>
                </div>
            </div>
        </div>

        <div class="col-4 mb-2">
            <div class="card shadow-sm border-0 rounded-0 h-100">
                <div style="height:360px;">
                    <canvas id="DowntimeBarChart" width="10" height="10"></canvas>
                </div>
            </div>
        </div>
    </div>

    <hr class="border border-dark border-0 mb-4 opacity-100">
    <div class="row align-items-end mb-5 mt-4">
        <div class="col-12 mb-2">
            <div class="card shadow-sm border-0 rounded-0 h-100">
                <canvas id="DailyEfficiencyChart" width="50" height="10"></canvas>
            </div>
        </div>

        <hr class="border border-dark border-0 mb-4 opacity-100">

        <div class="row align-items-end mb-5 mt-1">
            <div class="col-6 mb-2">
                <div class="card shadow-sm border-0 rounded-0 h-100">
                    <div style="height:360px;">
                        <canvas id="FamilyStackedChart" width="10" height="10"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-6 mb-2">
                <div class="card shadow-sm border-0 rounded-0 h-100">
                    <div style="height:360px;">
                        <canvas id="FamilyMetersChart" width="10" height="10"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <hr class="border border-dark border-0 mb-4 opacity-100">
        <div class="row align-items-end mb-5 mt-4">
            <div class="col-12 mb-2">
                <div class="card shadow-sm border-0 rounded-0 h-100">
                    <canvas id="SpeedLineChart" width="50" height="10"></canvas>
                </div>
            </div>
    </div>

    <!-- Mensaje de error inline -->
    <div id="errorMessage" class="text-danger fw-bold mt-3"></div>
</div>

@section Scripts {
    <!-- Importar Chart.js y el plugin de datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <script>
        let totmChart;
        let efficiencyChart;
        let downtimeChart;
        let dailyEfficiencyChart;
        let familyStackedChart;
        let familyMetersChart;
        let speedChart;

        async function loadEfficiencyChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;

            const response = await fetch(`/Extruder/GetEfficiencyByShift?extruder=${extruder}&date=${date}`);
            const result = await response.json();

            const labels = result.map(r => r.shift);
            const data = result.map(r => r.efficiency);

            const ctx = document.getElementById("EfficiencyBarChart").getContext("2d");

            if (!efficiencyChart) {
                efficiencyChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Eficiencia (%)",
                            data: data,
                            backgroundColor: ["rgba(49, 92, 213)", "rgba(49, 92, 213)", "rgba(49, 92, 213)"]
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 1200,
                            easing: "easeOutQuart"
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + "%";
                                    }
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Eficiencia por Turno",
                                font: { size: 18, weight: "bold" },
                                color: "#333"
                            }
                        }
                    }
                });
            } else {
                efficiencyChart.data.labels = labels;
                efficiencyChart.data.datasets[0].data = data;
                efficiencyChart.update();
            }
        }

        async function loadTotmChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const shift = document.getElementById("shiftSelect").value;
            const date = document.getElementById("startDate").value;
            const spinner = document.getElementById("spinner");
            const errorMessage = document.getElementById("errorMessage");

            spinner.style.display = "inline-block";
            errorMessage.innerText = "";

            try {
                const response = await fetch(`/Extruder/GetTotmData?extruder=${extruder}&shift=${shift}&date=${date}`);
                const result = await response.json();

                let totm1 = 0;
                let totm0 = 0;

                result.forEach(r => {
                    if (r.totm == 1) totm1 = r.count;
                    else if (r.totm == 0) totm0 = r.count;
                });

                const labels = ["Tiempo de Operacion","Tiempo Muerto"];
                const data = [totm1, totm0];

                const ctx = document.getElementById("TotmPieChart").getContext("2d");

                // Texto dinámico para el título
                const chartTitle = `Eficiencia Diaria % – ${extruder} – ${shift} (${date})`;

                if (!totmChart) {
                    // Crear gráfico inicial
                    totmChart = new Chart(ctx, {
                        type: "pie",
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: ["rgba(49, 92, 213)", "rgba(153, 153, 153)"], // verde y rojo
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: {
                                duration: 1200,
                                easing: "easeOutQuart"
                            },
                            plugins: {
                                legend: { position: "bottom" },
                                title: {
                                    display: true,
                                    text: chartTitle,
                                    font: {
                                        size: 18,
                                        weight: "bold"
                                    },
                                    color: "#333",
                                    padding: {
                                        top: 10,
                                        bottom: 20
                                    }
                                },
                                datalabels: {
                                    color: "#fff",
                                    font: { weight: "bold", size: 14 },
                                    formatter: (value, ctx) => {
                                        const dataset = ctx.chart.data.datasets[0].data;
                                        const total = dataset.reduce((a, b) => a + b, 0);
                                        if (total === 0) return "0 (0%)";
                                        const porcentaje = (value / total * 100).toFixed(1);
                                        return `${value} (${porcentaje}%)`;
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                } else {
                    // Actualizar datos y título suavemente
                    totmChart.data.datasets[0].data = data;
                    totmChart.options.plugins.title.text = chartTitle;
                    totmChart.update();
                }
            } catch (error) {
                errorMessage.innerText = "Error cargando datos.";
            } finally {
                spinner.style.display = "none";
            }
        }

        async function loadDowntimeChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;

            const response = await fetch(`/Extruder/GetDowntimeByShift?extruder=${extruder}&date=${date}`);
            const result = await response.json();

            const labels = result.map(r => r.shift);
            const data = result.map(r => Number(r.downtime));

            const ctx = document.getElementById("DowntimeBarChart").getContext("2d");

            if (!downtimeChart) {
                downtimeChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Tiempo Muerto (%)",
                            data: data,
                            backgroundColor: ["rgba(153, 153, 153,1.0)", "rgba(153, 153, 153,1.0)", "rgba(153, 153, 153,1.0)"] // rojo

                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 1200,
                            easing: "easeOutQuart"
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: value => value + "%"
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Tiempo Muerto por Turno",
                                font: { size: 18, weight: "bold" },
                                color: "#333"
                            }
                        }
                    }
                });
            } else {
                downtimeChart.data.labels = labels;
                downtimeChart.data.datasets[0].data = data;
                downtimeChart.update();
            }
        }

        async function loadDailyEfficiencyChart() {
            const extruder = document.getElementById("ExtruderSelect").value;

            const response = await fetch(`/Extruder/GetDailyEfficiencyLast7Days?extruder=${extruder}`);
            const result = await response.json();

            const labels = result.map(r => r.date);
            const data = result.map(r => Number(r.efficiency));

            const ctx = document.getElementById("DailyEfficiencyChart").getContext("2d");

            if (!dailyEfficiencyChart) {
                dailyEfficiencyChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Eficiencia Diaria (%)",
                            data: data,
                            backgroundColor:"rgba(49, 92, 213)",
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 1200,
                            easing: "easeOutQuart"
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: value => value + "%"
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Eficiencia Diaria – Últimos 7 Días",
                                font: { size: 18, weight: "bold" },
                                color: "#333"
                            }
                        }
                    }
                });
            } else {
                dailyEfficiencyChart.data.labels = labels;
                dailyEfficiencyChart.data.datasets[0].data = data;
                dailyEfficiencyChart.update();
            }
        }

        async function loadFamilyStackedChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;
            const shift = document.getElementById("shiftSelect").value;

            const response = await fetch(`/Extruder/GetFamilyRuntime?extruder=${extruder}&date=${date}&shift=${shift}`);
            const result = await response.json();

            const labels = ["Producción"]; // una sola barra
            const datasets = result.map(r => ({
                label: r.family,
                data: [r.minutes],
                backgroundColor: getRandomColor()
            }));

            const ctx = document.getElementById("FamilyStackedChart").getContext("2d");

            if (!familyStackedChart) {
                familyStackedChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Tiempo por Familia (Dinámico)",
                                font: { size: 18, weight: "bold" }
                            }
                        }
                    }
                });
            } else {
                familyStackedChart.data.labels = labels;
                familyStackedChart.data.datasets = datasets;
                familyStackedChart.update();
            }
        }

        function getRandomColor() {
            return `hsl(${Math.floor(Math.random() * 360)}, 70%, 55%)`;
        }

        async function loadFamilyMetersChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;
            const shift = document.getElementById("shiftSelect").value;

            const response = await fetch(`/Extruder/GetFamilyMeters?extruder=${extruder}&date=${date}&shift=${shift}`);
            const result = await response.json();

            const labels = ["Producción"]; // una sola barra
            const datasets = result.map(r => ({
                label: r.family,
                data: [r.meters],
                backgroundColor: getRandomColor()
            }));

            const ctx = document.getElementById("FamilyMetersChart").getContext("2d");

            if (!familyMetersChart) {
                familyMetersChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Metros Extruidos por Familia",
                                font: { size: 18, weight: "bold" }
                            }
                        }
                    }
                });
            } else {
                familyMetersChart.data.labels = labels;
                familyMetersChart.data.datasets = datasets;
                familyMetersChart.update();
            }
        }

        function getRandomColor() {
            return `hsl(${Math.floor(Math.random() * 360)}, 70%, 55%)`;
        }



            async function loadSpeedChart() {
                const extruder = document.getElementById("ExtruderSelect").value;
                const date = document.getElementById("startDate").value;
                const shift = document.getElementById("shiftSelect").value;

                const response = await fetch(`/Extruder/GetSpeedData?extruder=${extruder}&date=${date}&shift=${shift}`);
                const result = await response.json();

                const labels = result.map(r => r.timestamp);
                const data = result.map(r => Number(r.speed));

                const ctx = document.getElementById("SpeedLineChart").getContext("2d");

                if (!speedChart) {
                    speedChart = new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: labels,
                            datasets: [{
                                label: "Velocidad (RPM)",
                                data: data,
                                borderColor: "#007bff",
                                backgroundColor: "rgba(0,123,255,0.2)",
                                borderWidth: 2,
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: {
                                duration: 1200,
                                easing: "easeOutQuart"
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: "Velocidad por Tiempo",
                                    font: { size: 18, weight: "bold" },
                                    color: "#333"
                                }
                            }
                        }
                    });
                } else {
                    speedChart.data.labels = labels;
                    speedChart.data.datasets[0].data = data;
                    speedChart.update();
                }
            }

        // Evento del botón Apply
        document.getElementById("applyFilter").addEventListener("click", loadTotmChart);
        document.getElementById("applyFilter").addEventListener("click", loadEfficiencyChart);
        document.getElementById("applyFilter").addEventListener("click", loadDowntimeChart);
        document.getElementById("applyFilter").addEventListener("click", loadDailyEfficiencyChart);
        document.getElementById("applyFilter").addEventListener("click", loadFamilyStackedChart);
        document.getElementById("applyFilter").addEventListener("click", loadFamilyMetersChart);
        document.getElementById("applyFilter").addEventListener("click", loadSpeedChart);

        // Cargar inicial al abrir la página con fecha actual y turno All
        window.onload = () => {
            const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
            document.getElementById("startDate").value = today;
            document.getElementById("shiftSelect").value = "All";
            const extruder = document.getElementById("ExtruderSelect").value;
            loadTotmChart(extruder, "All", today);
            loadEfficiencyChart();
            loadDowntimeChart();
            loadDailyEfficiencyChart();
            loadFamilyStackedChart();
            loadFamilyMetersChart();
            loadSpeedChart();
        };
    </script>
}