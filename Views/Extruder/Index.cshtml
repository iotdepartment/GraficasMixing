@model List<GraficasMixing.Models.SetPointExtruder>

@{
    var extruders = ViewBag.Extruders as List<string>;

    ViewData["Title"] = "Extruder Efficiency";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <h2 class="text-end">Mesus Charts (Extruder Area) <i class="bi bi-clipboard-data"></i></h2>
    <hr class="border border-dark border-0 mb-4 opacity-100">

<!-- Nuevo botón para ir a la vista de Chart -->


<div class="row mb-3 mt-2">
    <div class="col-12 text-end">
        <a href="@Url.Action("Chart", "Extruder")" class="btn btn-info rounded-pill">
            <i class="bi bi-bar-chart"></i> Ver Gráfica
        </a>
    </div>
</div>
   <div class="card shadow-sm border border-1 bg-white rounded-4 p-3">
    <div class="row align-items-end">
        
        <!-- Extruder -->
        <div class="col-2">
            <label for="ExtruderSelect">Extrusora:</label><br>
            <select id="ExtruderSelect" class="form-select">
                @foreach (var extruder in extruders)
                {
                    <option value="@extruder">@extruder</option>
                }
            </select>
        </div>

        <!-- Shift -->
        <div class="col-2">
            <label for="shiftSelect">Turno:</label><br>
            <select id="shiftSelect" class="form-select">
                <option value="Turno1" selected>Turno 1(7:00 - 15:00)</option>
                <option value="Turno2">Turno 2(15:00 - 24:00)</option>
                <option value="Turno3">Turno 3(00:00 - 7:00)</option>
                <option value="All">Todos los Turnos</option>
            </select>
        </div>

        <!-- Fecha -->
        <div class="col-2">
            <label for="startDate">Fecha:</label><br>
            <input type="date" id="startDate" class="form-control">
        </div>

        <!-- Submit button-->
        <div class="col-1 me-0 ">
            <div class="d-grid gap-2">
                <button type="button" id="applyFilter" class="btn btn-primary rounded-pill">
                    Apply
                    <span id="spinner" class="spinner-border spinner-border-sm" style="display:none;"></span>
                </button>
            </div>
        </div>

        <!-- Export -->
        <div class="col-2">
            <button id="exportChartBtn" class="btn btn-outline-success">
                <i class="bi bi-download"></i> Export Report
            </button>
        </div>

        <!-- Botón para abrir modal -->
        <div class="col-2">
            <button type="button" id="openSetPointModal" class="btn btn-success rounded-pill">
                Ver SetPoints
            </button>
        </div>

     

    </div>
</div>

<!-- Renderizamos el modal fijo con los datos -->
@await Html.PartialAsync("Partials/_ExtruderModal", Model)

    @* //Primera Fila  *@

    <div class="row g-3 mt-1 mb-5">

        <!-- Gráfica 1 -->
        <div class="col-4">
            <div class="card shadow-sm border border-1 rounded-4 p-3 d-flex justify-content-center align-items-center" style="height: 360px;">
                <canvas id="TotmPieChart"></canvas>
            </div>
        </div>

        <!-- Gráfica 2 -->
        <div class="col-4">
            <div class="card shadow-sm border border-1 rounded-4 p-3 d-flex justify-content-center align-items-center" style="height: 360px;">
                <canvas id="EfficiencyBarChart"></canvas>
            </div>
        </div>

        <!-- Gráfica 3 -->
        <div class="col-4">
            <div class="card shadow-sm border border-1 rounded-4 p-3 d-flex justify-content-center align-items-center" style="height: 360px;">
                <canvas id="DowntimeBarChart"></canvas>
            </div>
        </div>

    </div>

    <hr class="border border-dark border-0 mb-4 opacity-100">

    <div class="card shadow-sm border border-1 rounded-4 p-3 mt-4">
        <h5 class="mb-3">Producción por familia</h5>
        <div class="table-responsive">
            <table id="produccionTable" class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Familia</th>
                        <th>Metros Producidos</th>
                        <th>Velocidad Promedio (m/min)</th>
                        <th>SetPoint Velocidad (m/min)</th>
                        <th>% Efectividad</th>

                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    
    <hr class="border border-dark border-0 mb-4 opacity-100">


    @* //Segunda Fila *@

    <div class="row align-items-end mb-5 mt-4">
        <div class="col-12 mb-2">
            <div class="card shadow-sm border border-1 rounded-4 p-3 d-flex justify-content-center align-items-center" style="height: 360px;">
                <canvas id="DailyEfficiencyChart" width="50" height="10"></canvas>
            </div>
        </div>
    </div>
        
    <hr class="border border-dark border-0 mb-4 opacity-100">

    @* //Tercera Fila     *@

    <div class="row g-3 mb-5 mt-1">

        <div class="col-6">
            <div class="card shadow-sm border border-1 rounded-4 p-3">
                <canvas id="FamilyStackedChart" style="width:100%; height:360px;"></canvas>
            </div>
        </div>

        <div class="col-6">
            <div class="card shadow-sm border border-1 rounded-4 p-3">
                <canvas id="FamilyMetersChart" style="width:100%; height:360px;"></canvas>
            </div>
        </div>

    </div>

    <hr class="border border-dark border-0 mb-4 opacity-100">

    @* // Cuarta Fila *@
    <div class="row align-items-end mb-5 mt-4">
        <div class="col-12 mb-2">
            <div class="card shadow-sm border border-1 rounded-4 p-3 d-flex justify-content-center align-items-center" style="height: 360px;">

                    <canvas id="SpeedLineChart" style="width:100%; height:100%;"></canvas>
            </div>
        </div>
    </div>



    <!-- Mensaje de error inline -->
    <div id="errorMessage" class="text-danger fw-bold mt-3"></div>

@section Scripts {
    <!-- Importar Chart.js y el plugin de datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <script>
        // Abrir modal al hacer clic en el botón
        document.getElementById("openSetPointModal").addEventListener("click", function () {
            var modal = new bootstrap.Modal(document.getElementById("extruderModal"));
            modal.show();
        });
    </script>

    <script>
        let totmChart;
        let efficiencyChart;
        let downtimeChart;
        let dailyEfficiencyChart;
        let familyStackedChart;
        let familyMetersChart;
        let speedChart;

        async function loadTotmChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const shift = document.getElementById("shiftSelect").value;
            const date = document.getElementById("startDate").value;
            const spinner = document.getElementById("spinner");
            const errorMessage = document.getElementById("errorMessage");

            spinner.style.display = "inline-block";
            errorMessage.innerText = "";

            try {
                const response = await fetch(`/Extruder/GetTotmData?extruder=${extruder}&shift=${shift}&date=${date}`);
                const result = await response.json();

                let totm1 = 0;
                let totm0 = 0;

                result.forEach(r => {
                    if (r.totm == 1) totm1 = r.count;
                    else if (r.totm == 0) totm0 = r.count;
                });

                const labels = ["Tiempo de Operacion","Tiempo Muerto"];
                const data = [totm1, totm0];

                const ctx = document.getElementById("TotmPieChart").getContext("2d");

                // Texto dinámico para el título
                const chartTitle = `Eficiencia Diaria % – ${extruder} – ${shift} (${date})`;

                if (!totmChart) {
                    // Crear gráfico inicial
                    totmChart = new Chart(ctx, {
                        type: "pie",
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: ["rgba(49, 92, 213)", "rgba(153, 153, 153)"], // verde y rojo
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: {
                                duration: 1200,
                                easing: "easeOutQuart"
                            },
                            plugins: {
                                legend: { position: "bottom" },
                                title: {
                                    display: true,
                                    text: "Eficiencia del dia (min / %)",
                                    font: {
                                        size: 18,
                                        weight: "bold"
                                    },
                                    color: "#333",
                                    padding: {
                                        top: 10,
                                        bottom: 20
                                    }
                                },
                                datalabels: {
                                    color: "#fff",
                                    font: { weight: "bold", size: 14 },
                                    formatter: (value, ctx) => {
                                        const dataset = ctx.chart.data.datasets[0].data;
                                        const total = dataset.reduce((a, b) => a + b, 0);
                                        if (total === 0) return "0 (0%)";
                                        const porcentaje = (value / total * 100).toFixed(1);
                                        return `${value} (${porcentaje}%)`;
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                } else {
                    // Actualizar datos y título suavemente
                    totmChart.data.datasets[0].data = data;
                    totmChart.options.plugins.title.text = chartTitle;
                    totmChart.update();
                }
            } catch (error) {
                errorMessage.innerText = "Error cargando datos.";
            } finally {
                spinner.style.display = "none";
            }
        }

        async function loadEfficiencyChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;

            const response = await fetch(`/Extruder/GetEfficiencyByShift?extruder=${extruder}&date=${date}`);
            const result = await response.json();

            const labels = result.map(r => r.shift);
            const data = result.map(r => r.efficiency);

            const ctx = document.getElementById("EfficiencyBarChart").getContext("2d");

            if (!efficiencyChart) {
                efficiencyChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Eficiencia (%)",
                            data: data,
                            backgroundColor: ["rgba(49, 92, 213)", "rgba(49, 92, 213)", "rgba(49, 92, 213)"]
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 1200,
                            easing: "easeOutQuart"
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + "%";
                                    }
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Porcentaje de eficiencia por turno (%)",
                                font: { size: 18, weight: "bold" },
                                color: "#333",
                                padding: { top: 20, bottom: 10 } // espacio extra para claridad
                            },
                            datalabels: {
                                anchor: "center",   // dentro de la barra
                                align: "center",    // centrado vertical
                                formatter: function(value) {
                                    return value.toFixed(1) + "%"; // un decimal + símbolo %
                                },
                                font: {
                                    weight: "bold"
                                },
                                color: "#fff" // blanco para contraste sobre azul
                            }
                        }
                    },
                    plugins: [ChartDataLabels] // activa el plugin
                });
            } else {
                efficiencyChart.data.labels = labels;
                efficiencyChart.data.datasets[0].data = data;
                efficiencyChart.update();
            }
        }

        async function loadDowntimeChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;

            const response = await fetch(`/Extruder/GetDowntimeByShift?extruder=${extruder}&date=${date}`);
            const result = await response.json();

            const labels = result.map(r => r.shift);
            const data = result.map(r => Number(r.downtime));

            const ctx = document.getElementById("DowntimeBarChart").getContext("2d");

            if (!downtimeChart) {
                downtimeChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Tiempo Muerto (%)",
                            data: data,
                            backgroundColor: ["rgba(153, 153, 153,1.0)", "rgba(153, 153, 153,1.0)", "rgba(153, 153, 153,1.0)"]
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 1200,
                            easing: "easeOutQuart"
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: value => value + "%"
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Porcentaje de tiempo muerto por turno (%)",
                                font: { size: 18, weight: "bold" },
                                color: "#333",
                                padding: { top: 20, bottom: 10 } // espacio extra para claridad
                            },
                            datalabels: {
                                anchor: "center",   // dentro de la barra
                                align: "center",    // centrado vertical
                                formatter: function(value) {
                                    return value.toFixed(1) + "%"; // un decimal + símbolo %
                                },
                                font: {
                                    weight: "bold"
                                },
                                color: "#fff" // blanco para contraste sobre gris
                            }
                        }
                    },
                    plugins: [ChartDataLabels] // activa el plugin
                });
            } else {
                downtimeChart.data.labels = labels;
                downtimeChart.data.datasets[0].data = data;
                downtimeChart.update();
            }
        }

        async function loadDailyEfficiencyChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value; // aquí tomamos la fecha seleccionada

            const response = await fetch(`/Extruder/GetDailyEfficiencyLast7Days?extruder=${extruder}&date=${date}`);
            const result = await response.json();

            const labels = result.map(r => r.date);
            const data = result.map(r => Number(r.efficiency));

            const ctx = document.getElementById("DailyEfficiencyChart").getContext("2d");

            if (!dailyEfficiencyChart) {
                dailyEfficiencyChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Eficiencia Diaria (%)",
                            data: data,
                            backgroundColor: "rgba(49, 92, 213)",
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 1200,
                            easing: "easeOutQuart"
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: value => value + "%"
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Eficiencia diaria de los últimos 7 días (%)",
                                font: { size: 18, weight: "bold" },
                                color: "#333",
                                padding: { top: 20, bottom: 10 }
                            },
                            datalabels: {
                                anchor: "center",
                                align: "center",
                                formatter: function(value) {
                                    return value.toFixed(1) + "%";
                                },
                                font: {
                                    weight: "bold"
                                },
                                color: "#fff"
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                dailyEfficiencyChart.data.labels = labels;
                dailyEfficiencyChart.data.datasets[0].data = data;
                dailyEfficiencyChart.update();
            }
        }

        async function loadFamilyStackedChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;
            const shift = document.getElementById("shiftSelect").value;

            const response = await fetch(`/Extruder/GetFamilyRuntime?extruder=${extruder}&date=${date}&shift=${shift}`);
            const result = await response.json();

            const labels = ["Producción"]; // una sola barra
            const datasets = result.map(r => ({
                label: r.family,
                data: [r.minutes],
                backgroundColor: getRandomColor()
            }));

            const ctx = document.getElementById("FamilyStackedChart").getContext("2d");

            if (!familyStackedChart) {
                familyStackedChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Tiempo de producción por familia (min)",
                                font: { size: 18, weight: "bold" },
                                padding: { top: 20, bottom: 10 }
                            },
                            datalabels: {
                                anchor: "center",   // dentro de cada segmento
                                align: "center",    // centrado vertical
                                formatter: function(value) {
                                    return value.toFixed(1) + " min"; // un decimal + unidad
                                },
                                font: {
                                    weight: "bold"
                                },
                                color: "#fff" // blanco para contraste sobre colores aleatorios
                            }
                        }
                    },
                    plugins: [ChartDataLabels] // activa el plugin
                });
            } else {
                familyStackedChart.data.labels = labels;
                familyStackedChart.data.datasets = datasets;
                familyStackedChart.update();
            }
        }

        function getRandomColor() {
            return `hsl(${Math.floor(Math.random() * 360)}, 70%, 55%)`;
        }

        async function loadFamilyMetersChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;
            const shift = document.getElementById("shiftSelect").value;

            const response = await fetch(`/Extruder/GetFamilyMeters?extruder=${extruder}&date=${date}&shift=${shift}`);
            const result = await response.json();

            const labels = ["Producción"]; // una sola barra
            const datasets = result.map(r => ({
                label: r.family,
                data: [r.meters],
                backgroundColor: getRandomColor()
            }));

            const ctx = document.getElementById("FamilyMetersChart").getContext("2d");

            if (!familyMetersChart) {
                familyMetersChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: "Metros extruidos por familia (metros)",
                                font: { size: 18, weight: "bold" },
                                padding: { top: 20, bottom: 10 }
                            },
                            datalabels: {
                                anchor: "center",   // dentro de cada segmento
                                align: "center",    // centrado vertical
                                formatter: function(value) {
                                    return value.toFixed(1) + " m"; // un decimal + unidad
                                },
                                font: {
                                    weight: "bold"
                                },
                                color: "#fff" // blanco para contraste sobre colores aleatorios
                            }
                        }
                    },
                    plugins: [ChartDataLabels] // activa el plugin
                });
            } else {
                familyMetersChart.data.labels = labels;
                familyMetersChart.data.datasets = datasets;
                familyMetersChart.update();
            }
        }

        async function loadSpeedChart() {
            const extruder = document.getElementById("ExtruderSelect").value;
            const date = document.getElementById("startDate").value;
            const shift = document.getElementById("shiftSelect").value;

            const response = await fetch(`/Extruder/GetSpeedData?extruder=${extruder}&date=${date}&shift=${shift}`);
            const result = await response.json();

            // Todos los timestamps únicos (eje X común)
            const allLabels = [...new Set(result.map(r => r.timestamp))];

            // Agrupar por familia
            const families = {};
            result.forEach(r => {
                if (!families[r.family]) {
                    families[r.family] = {};
                }
                families[r.family][r.timestamp] = Number(r.speed);
            });

            // Colores para las líneas
            const colors = [
                "rgba(255, 99, 132, 1)",   // rojo
                "rgba(54, 162, 235, 1)",   // azul
                "rgba(75, 192, 192, 1)",   // verde
                "rgba(255, 206, 86, 1)",   // amarillo
                "rgba(153, 102, 255, 1)",  // morado
                "rgba(255, 159, 64, 1)"    // naranja
            ];

            // Crear datasets por familia
            const datasets = Object.keys(families).map((family, index) => ({
                label: family || "Sin familia",
                data: allLabels.map(ts => families[family][ts] ?? null), // null si no hay dato
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length].replace("1)", "0.2)"),
                borderWidth: 2,
                tension: 0.3,
                fill: false
            }));

            const ctx = document.getElementById("SpeedLineChart").getContext("2d");

            if (!speedChart) {
                speedChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: allLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                           animation: {
                               duration: 1200,
                               easing: "easeOutQuart"
                         },
                         scales: {
                             y: {
                                 beginAtZero: true
                             },
                             x: {
                                 ticks: {
                                         callback: function(value, index, ticks) {
                                            // El label original
                                            const label = this.getLabelForValue(value);
                                            // Extraer solo la hora (HH:mm) del timestamp
                                            const dateObj = new Date(label);
                                            return dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                         },
                                         maxRotation: 45,
                                         minRotation: 30
                                 }
                             }
                         },
            plugins: {
                title: {
                    display: true,
                    text: "Velocidad durante el día (m/min)",
                    font: { size: 18, weight: "bold" },
                    color: "#333"
                },
                legend: {
                    position: "bottom",
                    labels: {
                        font: { size: 12, weight: "bold" },
                        color: "#333"
                    }
                }
            }
        }
                });
            } else {
                speedChart.data.labels = allLabels;
                speedChart.data.datasets = datasets;
                speedChart.update();
            }
        }

        function cargarProduccionFamilias() {
            const fecha = document.getElementById("startDate").value;
            const turno = document.getElementById("shiftSelect").value;
            const extruder = document.getElementById("ExtruderSelect").value;

            document.getElementById("spinner").style.display = "inline-block";

            fetch(`/Extruder/GetProduccionFamilias?extruder=${extruder}&shift=${turno}&date=${fecha}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector("#produccionTable tbody");
                    tbody.innerHTML = "";

                    data.forEach(item => {
                        const row = `<tr>
                            <td>${item.familia}</td>
                            <td>${item.metrosProducidos}</td>
                            <td>${item.velocidadPromedio.toFixed(2)}</td>
                            <td>${item.setPointVelocidad}</td>
                            <td>${item.porcentajeEfectividad.toFixed(2)} %</td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });

                    document.getElementById("spinner").style.display = "none";
                });
        }

        // Evento del botón Apply
        document.getElementById("applyFilter").addEventListener("click", loadTotmChart);
        document.getElementById("applyFilter").addEventListener("click", loadEfficiencyChart);
        document.getElementById("applyFilter").addEventListener("click", loadDowntimeChart);
        document.getElementById("applyFilter").addEventListener("click", loadDailyEfficiencyChart);
        document.getElementById("applyFilter").addEventListener("click", loadFamilyStackedChart);
        document.getElementById("applyFilter").addEventListener("click", loadFamilyMetersChart);
        document.getElementById("applyFilter").addEventListener("click", loadSpeedChart);
        document.getElementById("applyFilter").addEventListener("click", cargarProduccionFamilias);


        // Cargar inicial al abrir la página con fecha actual y turno All
        window.onload = () => {
            const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
            document.getElementById("startDate").value = today;
            document.getElementById("shiftSelect").value = "All";
            const extruder = document.getElementById("ExtruderSelect").value;
            loadTotmChart(extruder, "All", today);
            loadEfficiencyChart();
            loadDowntimeChart();
            loadDailyEfficiencyChart();
            loadFamilyStackedChart();
            loadFamilyMetersChart();
            loadSpeedChart();
            cargarProduccionFamilias();
        };
    </script>
}