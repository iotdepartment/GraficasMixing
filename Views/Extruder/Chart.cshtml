@model GraficasMixing.ViewModels.EstadoCardViewModel


@{
    Layout = "~/Views/Extruder/Partials/_LayoutNoNav.cshtml";
    ViewData["Title"] = "Extruder 1";
}

<!-- Bootstrap CSS -->
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    .profile-card {
        position: relative;
        overflow: visible; /* permite que la imagen sobresalga */
        text-align: center;
    }

        .profile-card img {
            position: absolute;
            top: -60px; /* sobresale la mitad */
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

    .profile-info {
        margin-top: 70px; /* espacio para la imagen */
    }

        .profile-info p {
            margin-bottom: 12px;
        }
</style>

<div class="row g-3 mt-5 mb-5">
    <!-- Card de información -->
    <div class="col-md-3">
        <div class="card shadow-sm border-0 rounded-4 p-3 profile-card" style="height: 400px;">
            <!-- Imagen de perfil -->
            <img src="~/Images/tm/3566.png" alt="Foto de perfil">

            <!-- Información -->
            <div class="profile-info">
                <h4 class="card-title mb-4 fw-bold fs-4">@Model.Extruder</h4>

                <p class="fs-5"><strong>Team Member:</strong><br>@Model.Empleado</p>
                <p class="fs-5"><strong>Mandril:</strong><br>@Model.Mandril</p>
                <p class="fs-5"><strong>Contador:</strong><br>@Model.Contador</p>
            </div>
        </div>
    </div>

    <!-- Gráfica 1: Pie chart eficiencia diaria -->
    <div class="col-md-4">
        <div class="card shadow-sm border-0 rounded-4 p-3 d-flex justify-content-center align-items-center" style="height: 400px;">
            <canvas id="TotmPieChart"></canvas>
        </div>
    </div>

    <!-- Gráfica 2: Barras producción vs downtime por turno -->
    <div class="col-md-5">
        <div class="card shadow-sm border-0 rounded-4 p-3 d-flex justify-content-center align-items-center" style="height: 400px;">
            <div id="productionDowntimeChart" style="width:100%;height:400px;"></div>
        </div>
    </div>
</div>

<div class="row align-items-end mb-5 mt-4">
    <div class="col-12 mb-2">
        <div class="card shadow-sm border border-1 rounded-4 p-3 position-relative" style="height: 420px;">

            <!-- Gráfica -->
            <div id="SpeedLineChart" style="width:100%; height:100%;"></div>

            <!-- Velocidad actual en la parte superior derecha -->
            <div class="position-absolute top-0 end-0 mt-2 me-3 text-end">
                <div class="fw-bold">Velocidad:</div>
                <span id="ultimoRegistro" class="badge bg-primary fs-6"></span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <script>


        // ---------------------------
        // Gráfica de pie eficiencia diaria
        // ---------------------------
        let totmChart;

        function cargarOperacionVsDowntimeChart() {
            fetch('/Extruder/GetDailyTotmData')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('TotmPieChart').getContext('2d');

                    if (totmChart) {
                        totmChart.data.labels = data.map(d => d.label);
                        totmChart.data.datasets[0].data = data.map(d => d.value);
                        totmChart.update('none');
                    } else {
                        totmChart = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: data.map(d => d.label),
                                datasets: [{
                                    data: data.map(d => d.value),
                                    backgroundColor: ['#66BB6A', '#EF5350'], 
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'bottom', labels: { font: { size: 14 } } },
                                    title: {
                                        display: true,
                                                text: " Eficiencia diaria % - Extruder 1 ",
                                        font: { size: 22, weight: 'bold' },
                                        color: '#333'
                                    },
                                    datalabels: {
                                        color: '#fff',
                                        font: { weight: 'bold', size: 14 },
                                        formatter: (value, ctx) => {
                                            let dataset = ctx.chart.data.datasets[0].data;
                                            let total = dataset.reduce((a, b) => a + b, 0);
                                            let porcentaje = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return value + " min (" + porcentaje + "%)";
                                        }
                                    }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });
                    }
                })
                .catch(err => console.error("Error cargando datos:", err));
        }

        cargarOperacionVsDowntimeChart();
        setInterval(cargarOperacionVsDowntimeChart, 10000);

        // ---------------------------
        // Gráfica de barras por turno
        // ---------------------------
        let productionChart = echarts.init(document.getElementById('productionDowntimeChart'));

        function cargarProductionVsDowntimeChart() {
            fetch('/Extruder/GetProductionVsDowntimeByShift')
                .then(response => response.json())
                .then(data => {
                    const option = {
                        title: {
                            text: 'Operación vs Downtime por Turno - Extruder 1',
                            left: 'center',
                            textStyle: { fontSize: 20, fontWeight: 'bold' }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: params => {
                                let total = params.reduce((sum, p) => sum + p.value, 0);
                                return params.map(p => {
                                    let porcentaje = total > 0 ? ((p.value / total) * 100).toFixed(1) : 0;
                                    return `${p.seriesName}: ${p.value} (${porcentaje}%)`;
                                }).join('<br>');
                            }
                        },
                        legend: {
                            bottom: 0,
                            textStyle: { fontSize: 14 }
                        },
                        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: data.map(d => d.turno),
                            axisLabel: { fontSize: 14 }
                        },
                        yAxis: {
                            type: 'value',
                            axisLabel: { fontSize: 14 }
                        },
                        series: [
                            {
                                name: 'Operación',
                                type: 'bar',
                                stack: 'total',
                                data: data.map(d => d.produccion),
                                itemStyle: { color: '#66BB6A' },
                                label: {
                                    show: true,
                                    position: 'inside',
                                    formatter: (params) => {
                                        let turno = data[params.dataIndex];
                                        let total = turno.produccion + turno.downtime;
                                        let porcentaje = total > 0 ? ((params.value / total) * 100).toFixed(1) : 0;
                                        return `${params.value} min (${porcentaje}%)`;
                                    },
                                    fontSize: 12,
                                    color: '#fff'
                                }
                            },
                            {
                                name: 'Downtime',
                                type: 'bar',
                                stack: 'total',
                                data: data.map(d => d.downtime),
                                itemStyle: { color: '#EF5350' },
                                label: {
                                    show: true,
                                    position: 'inside',
                                    formatter: (params) => {
                                        let turno = data[params.dataIndex];
                                        let total = turno.produccion + turno.downtime;
                                        let porcentaje = total > 0 ? ((params.value / total) * 100).toFixed(1) : 0;
                                        return `${params.value} min (${porcentaje}%)`;
                                    },
                                    fontSize: 12,
                                    color: '#fff'
                                }
                            }
                        ]
                    };

                    productionChart.setOption(option);
                })
                .catch(err => console.error("Error cargando datos:", err));
        }

        cargarProductionVsDowntimeChart();
        setInterval(cargarProductionVsDowntimeChart, 10000);


        let speedChart = echarts.init(document.getElementById('SpeedLineChart'), null, {
            devicePixelRatio: window.devicePixelRatio
        });

        fetch('/Extruder/GetExtruder1SpeedHistoryByShift')
        .then(response => response.json())
        .then(data => {
            const registros = data.registros;
            const setPoint = data.setpoint;

            // Último registro
            const ultimo = registros[registros.length - 1];
            document.getElementById("ultimoRegistro").innerText =
                `${ultimo.velocidad.toFixed(2)} m/min`;

            // Configuración de la gráfica con línea roja del setpoint
            const option = {
                title: {
                    text: 'Velocidad por Turno - Extruder 1 (7:00 am a 7:00 am)',
                    left: 'center',
                    textStyle: { fontSize: 20, fontWeight: 'bold' }
                },
                tooltip: { trigger: 'axis' },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: registros.map(d => d.hora),
                    axisLabel: { fontSize: 12 }
                },
                yAxis: {
                    type: 'value',
                    name: 'Velocidad (m/min)',
                    axisLabel: { fontSize: 12 }
                },
                series: [
                    {
                        name: 'Velocidad',
                        type: 'line',
                        smooth: true,
                        data: registros.map(d => d.velocidad),
                        lineStyle: { width: 3 },
                        itemStyle: {
                            color: params => {
                                const turno = registros[params.dataIndex].turno;
                                if (turno === "Turno 1") return '#42A5F5'; // azul
                                if (turno === "Turno 2") return '#66BB6A'; // verde
                                return '#EF5350'; // rojo
                            }
                        },
                        markLine: {
                            symbol: 'none', // sin flechas
                            label: {
                                show: true,
                                position: 'insideEndTop', // evita que se corte
                                formatter: `Setpoint: ${setPoint.toFixed(2)} m/min`,
                                color: 'red',
                                fontWeight: 'bold'
                            },
                            lineStyle: { color: 'red', type: 'solid', width: 2 },
                            data: [
                                { yAxis: setPoint }
                            ]
                        }
                    }
                ]
            };

            speedChart.setOption(option);
        })
        .catch(err => console.error("Error cargando datos:", err));

        cargarSpeedLineChart();
        setInterval(cargarSpeedLineChart, 10000);

        window.addEventListener('resize', () => {
            speedChart.resize();
        });
    </script>
}