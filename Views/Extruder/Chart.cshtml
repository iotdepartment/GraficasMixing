@model GraficasMixing.ViewModels.EstadoCardViewModel


@{
    Layout = "~/Views/Extruder/Partials/_LayoutNoNav.cshtml";
    ViewData["Title"] = "Extruder 1";
}

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid">
    <div class="row g-3 mt-3 mb-5">
        <!-- Card del logo -->
        <div class="col-md-1 d-flex align-items-stretch">
            <div class="card shadow-sm border-0 rounded-4 d-flex justify-content-center align-items-center text-center w-100 h-25" style="height: 400px;">
                <img src="~/Images/Logo.png"
                     alt="Logo empresa"
                     class="img-fluid"
                     style="max-width: 100px; height: auto;">
            </div>
        </div>

        <div class="col-md-2 d-flex align-items-stretch">
            <div class="card shadow-sm border-0 rounded-4 text-center w-100 d-flex flex-column justify-content-between h-100">

                <!-- Imagen de perfil arriba -->
                <div class="d-flex justify-content-center mt-3">
                    <img src="@Url.Action("GetFotoEmpleado", "Extruder", new { numeroEmpleado = Model.NumeroEmpleado })"
                         alt="Foto de perfil"
                         class="rounded-circle border border-4 border-secondary"
                         style="width: 100px; height: 100px; object-fit: cover;">
                </div>

                <!-- Información al centro -->
                <div class="card-body d-flex flex-column justify-content-center">
                    <!-- Extruder arriba -->
                    <h5 class="fw-bold text-primary mb-1">@Model.Extruder</h5>

                    <!-- Team Member debajo -->
                    <h6 class="fw-semibold mb-2">@Model.Empleado</h6>

                    <!-- Mandril más grande -->
                    <p class="fs-6 mb-2"><strong>Mandril:</strong><br>@Model.Mandril</p>

                    <!-- Fila con Tubo1, Tubo2 y Cover -->
                    <div class="d-flex justify-content-around">
                        <div>
                            <small><strong>Tubo 1</strong></small><br>
                            <span class="badge bg-info">@Model.Tubo1</span>
                        </div>
                        <div>
                            <small><strong>Tubo 2</strong></small><br>
                            <span class="badge bg-warning">@Model.Tubo2</span>
                        </div>
                        <div>
                            <small><strong>Cover</strong></small><br>
                            <span class="badge bg-secondary">@Model.Cover</span>
                        </div>
                    </div>
                </div>

                <!-- Contador abajo -->
                <div class="mb-4">
                    <strong>Contador:</strong><br>
                    <span id="contador" class="badge rounded-pill bg-success fs-6">@Model.Contador</span>
                </div>
            </div>
        </div>

        <!-- Gráfica 1 -->
        <div class="col-md-4 d-flex align-items-stretch">
            <div class="card shadow-sm border-0 rounded-4 p-3 d-flex justify-content-center align-items-center w-100" style="height: 400px;">
                <canvas id="TotmPieChart"></canvas>
            </div>
        </div>

        <!-- Gráfica 2 -->
        <div class="col-md-5 d-flex align-items-stretch">
            <div class="card shadow-sm border-0 rounded-4 p-3 d-flex justify-content-center align-items-center w-100" style="height: 400px;">
                <div id="productionDowntimeChart" style="width:100%;height:100%;"></div>
            </div>
        </div>
    </div>

    <!-- Fila inferior -->
    <div class="row align-items-end mb-5 mt-4">
        <div class="col-12 mb-2">
            <div class="card shadow-sm border border-1 rounded-4 p-3 position-relative" style="height: 420px;">
                <!-- Gráfica -->
                <div id="SpeedLineChart" style="width:100%; height:100%;"></div>

                <!-- Velocidad actual -->
                <div class="position-absolute top-0 end-0 mt-2 me-3 text-end">
                    <div class="fw-bold">Velocidad:</div>
                    <span id="ultimoRegistro" class="badge bg-primary rounded-pill fs-6"></span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <script>

        function actualizarContador() {
            fetch(`/Extruder/GetContador?numeroEmpleado=${@Model.NumeroEmpleado}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("contador").innerText = data.contador;
                })
                .catch(err => console.error("Error actualizando contador:", err));
        }

     
        // Gráfica de pie eficiencia diaria

        let totmChart;

        function cargarOperacionVsDowntimeChart() {
            fetch('/Extruder/GetDailyTotmData')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('TotmPieChart').getContext('2d');

                    if (totmChart) {
                        totmChart.data.labels = data.map(d => d.label);
                        totmChart.data.datasets[0].data = data.map(d => d.value);
                        totmChart.update('none');
                    } else {
                        totmChart = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: data.map(d => d.label),
                                datasets: [{
                                    data: data.map(d => d.value),
                                    backgroundColor: ['#66BB6A', '#EF5350'], 
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'bottom', labels: { font: { size: 14 } } },
                                    title: {
                                        display: true,
                                                text: " Eficiencia diaria % - Extruder 1 ",
                                        font: { size: 22, weight: 'bold' },
                                        color: '#333'
                                    },
                                    datalabels: {
                                        color: '#fff',
                                        font: { weight: 'bold', size: 14 },
                                        formatter: (value, ctx) => {
                                            let dataset = ctx.chart.data.datasets[0].data;
                                            let total = dataset.reduce((a, b) => a + b, 0);
                                            let porcentaje = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return value + " min (" + porcentaje + "%)";
                                        }
                                    }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });
                    }
                })
                .catch(err => console.error("Error cargando datos:", err));
        }

        
        // Gráfica de barras por turno
        
        let productionChart = echarts.init(document.getElementById('productionDowntimeChart'));

        function cargarProductionVsDowntimeChart() {
            fetch('/Extruder/GetProductionVsDowntimeByShift')
                .then(response => response.json())
                .then(data => {
                    const option = {
                        title: {
                            text: 'Operación vs Downtime por Turno - Extruder 1',
                            left: 'center',
                            textStyle: { fontSize: 20, fontWeight: 'bold' }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: params => {
                                let total = params.reduce((sum, p) => sum + p.value, 0);
                                return params.map(p => {
                                    let porcentaje = total > 0 ? ((p.value / total) * 100).toFixed(1) : 0;
                                    return `${p.seriesName}: ${p.value} (${porcentaje}%)`;
                                }).join('<br>');
                            }
                        },
                        legend: {
                            bottom: 0,
                            textStyle: { fontSize: 14 }
                        },
                        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: data.map(d => d.turno),
                            axisLabel: { fontSize: 14 }
                        },
                        yAxis: {
                            type: 'value',
                            axisLabel: { fontSize: 14 }
                        },
                        series: [
                            {
                                name: 'Operación',
                                type: 'bar',
                                stack: 'total',
                                data: data.map(d => d.produccion),
                                itemStyle: { color: '#66BB6A' },
                                label: {
                                    show: true,
                                    position: 'inside',
                                    formatter: (params) => {
                                        let turno = data[params.dataIndex];
                                        let total = turno.produccion + turno.downtime;
                                        let porcentaje = total > 0 ? ((params.value / total) * 100).toFixed(1) : 0;
                                        return `${params.value} min (${porcentaje}%)`;
                                    },
                                    fontSize: 12,
                                    color: '#fff'
                                }
                            },
                            {
                                name: 'Downtime',
                                type: 'bar',
                                stack: 'total',
                                data: data.map(d => d.downtime),
                                itemStyle: { color: '#EF5350' },
                                label: {
                                    show: true,
                                    position: 'inside',
                                    formatter: (params) => {
                                        let turno = data[params.dataIndex];
                                        let total = turno.produccion + turno.downtime;
                                        let porcentaje = total > 0 ? ((params.value / total) * 100).toFixed(1) : 0;
                                        return `${params.value} min (${porcentaje}%)`;
                                    },
                                    fontSize: 12,
                                    color: '#fff'
                                }
                            }
                        ]
                    };

                    productionChart.setOption(option);
                })
                .catch(err => console.error("Error cargando datos:", err));
        }

        cargarProductionVsDowntimeChart();
        setInterval(cargarProductionVsDowntimeChart, 10000);


        let speedChart = echarts.init(document.getElementById('SpeedLineChart'), null, {
            devicePixelRatio: window.devicePixelRatio
        });

        function cargarSpeedLineChart() {
            fetch('/Extruder/GetExtruder1SpeedHistoryByShift')
            .then(response => response.json())
            .then(data => {
                const registros = data.registros;

                // Último registro
                const ultimo = registros[registros.length - 1];
                document.getElementById("ultimoRegistro").innerText =
                    `${ultimo.velocidad.toFixed(2)} m/min`;

                // Colores por familia
                const familyColors = {
                            "37 THIN LAYER": "#FF0000", // rojo
                            "37X47 CHS": "#00AA00", // verde
                            "33 WATER": "#0000FF", // azul
                    "FamiliaD": "#FFA500"  // naranja
                };

                // Detectar cambios de familia y crear segmentos de setpoint
                const setpointSeries = [];
                let currentSegment = [];
                let currentFamilia = registros[0].familia;

                for (let i = 0; i < registros.length; i++) {
                    const reg = registros[i];
                    const color = familyColors[reg.familia] || "red";

                    // Si cambia la familia, cerramos el segmento anterior y ponemos marcador al final
                    if (i > 0 && reg.familia !== registros[i - 1].familia) {
                        const lastReg = registros[i - 1];
                        const prevFamilia = registros[i - 1].familia;
                        const prevColor = familyColors[prevFamilia] || "red";

                        setpointSeries.push({
                            name: `Setpoint ${prevFamilia}`,
                            type: 'line',
                            smooth: false,
                            data: currentSegment,
                            lineStyle: { color: prevColor, width: 2, type: 'dashed' },
                            itemStyle: { color: prevColor },
                            markPoint: {
                                data: [{
                                    coord: [lastReg.hora, lastReg.setpoint],
                                    value: lastReg.setpoint.toFixed(2),
                                    symbolSize: 20,
                                    label: {
                                        show: true,
                                        position: 'top',
                                        formatter: () => `Setpoint (${prevFamilia}):\n${lastReg.setpoint.toFixed(2)} m/min`,
                                        color: prevColor,
                                        fontWeight: 'bold',
                                        fontSize: 11,
                                        lineHeight: 14
                                    },
                                    itemStyle: { color: prevColor }
                                }]
                            }
                        });

                        // Reiniciar segmento
                        currentSegment = [];
                        currentFamilia = reg.familia;
                    }

                    currentSegment.push([reg.hora, reg.setpoint]);
                }

                // Agregar último segmento con marcador al final
                const lastReg = registros[registros.length - 1];
                const lastColor = familyColors[currentFamilia] || "red";
                setpointSeries.push({
                    name: `Setpoint ${currentFamilia}`,
                    type: 'line',
                    smooth: false,
                    data: currentSegment,
                    lineStyle: { color: lastColor, width: 2, type: 'dashed' },
                    itemStyle: { color: lastColor },
                    markPoint: {
                        data: [{
                            coord: [lastReg.hora, lastReg.setpoint],
                            value: lastReg.setpoint.toFixed(2),
                            symbolSize: 20,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: () => `Setpoint (${currentFamilia}):\n${lastReg.setpoint.toFixed(2)} m/min`,
                                color: lastColor,
                                fontWeight: 'bold',
                                fontSize: 11,
                                lineHeight: 14
                            },
                            itemStyle: { color: lastColor }
                        }]
                    }
                });

                const option = {
                    title: {
                        text: 'Velocidad por Turno - Extruder 1 (7:00 am a 7:00 am)',
                        left: 'center',
                        textStyle: { fontSize: 20, fontWeight: 'bold' }
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: params => {
                            const idx = params[0].dataIndex;
                            const registro = registros[idx];
                            return `
                                Hora: ${registro.hora}<br>
                                Velocidad: ${registro.velocidad.toFixed(2)} m/min<br>
                                Turno: ${registro.turno}<br>
                                Familia: ${registro.familia}<br>
                                Setpoint: ${registro.setpoint.toFixed(2)} m/min
                            `;
                        }
                    },
                    grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                    xAxis: {
                        type: 'category',
                        data: registros.map(d => d.hora),
                        axisLabel: { fontSize: 12 }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Velocidad (m/min)',
                        axisLabel: { fontSize: 12 }
                    },
                    series: [
                        {
                            name: 'Velocidad',
                            type: 'line',
                            smooth: true,
                            data: registros.map(d => d.velocidad),
                            lineStyle: { width: 3 },
                            itemStyle: {
                                color: params => {
                                    const turno = registros[params.dataIndex].turno;
                                    if (turno === "Turno 1") return '#42A5F5'; // azul
                                    if (turno === "Turno 2") return '#66BB6A'; // verde
                                    return '#EF5350'; // rojo
                                }
                            }
                        },
                        ...setpointSeries
                    ]
                };

                speedChart.setOption(option);
            })
            .catch(err => console.error("Error cargando datos:", err));
        }

        // Ejecutar al cargar
        cargarSpeedLineChart();
        actualizarContador();
        cargarOperacionVsDowntimeChart();

        // Refrescar cada 10 segundos
        setInterval(cargarSpeedLineChart, 10000);
        setInterval(actualizarContador, 10000);
        setInterval(cargarOperacionVsDowntimeChart, 10000);

        window.addEventListener('resize', () => {
            speedChart.resize();
        });
    </script>
}