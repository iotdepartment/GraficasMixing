@model IEnumerable<GraficasMixing.Models.KneaderM>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<div class="col-12">
    <h2 class="text-end">Kneader Charts (Mixing Area)</h2>
    <hr class="border border-dark border-0 mb-4 opacity-100">
</div>

<div class="row mb-3 mt-2">
    <div class="col-12 text-end">
        <a href="@Url.Action("Chart", "Kneader")" class="btn btn-info rounded-pill">
            <i class="bi bi-bar-chart"></i> Ver Gráfica
        </a>
    </div>
</div>  

<div class="card shadow-sm border border-1 bg-white rounded-4 p-3 mb-3">
    <div class="row align-items-end">
        <!-- Dropdown Kneader -->
        <div class="col-2">
            <label for="kneaderSelect">Kneader:</label>
            <select id="kneaderSelect" class="form-select">
                <option value="Kneader1" selected>Kneader1</option>
                <option value="Kneader2">Kneader2</option>
                <option value="Kneader3">Kneader3</option>
            </select>
        </div>

        <!-- Dropdown Turno -->
        <div class="col-2">
            <label for="shiftSelect">Shift:</label>
            <select id="shiftSelect" class="form-select">
                <option value="Turno1" selected>Shift 1 (7:00 - 15:00)</option>
                <option value="Turno2">Shift 2 (15:00 - 24:00)</option>
                <option value="Turno3">Shift 3 (00:00 - 7:00)</option>
            </select>
        </div>

        <!-- Date + Button -->
        <div class="col-2">
            <label for="startDate">Date:</label>
            <input type="date" id="startDate" class="form-control">
        </div> 
          
        <div class="col-2">
            <button id="applyFilter" class="btn btn-primary">Apply</button>
            <span id="spinner" class="spinner-border spinner-border-sm me-2"></span>
        </div>
    </div>
</div>

<div class="card shadow-sm border border-1 bg-white rounded-4 p-3">

    <div class="col-12 d-flex align-items-stretch">
        <canvas id="kneaderChart" width="1500" height="350"></canvas>
    </div>

    <!-- Slicer de rango doble -->
    <div class="col-12 p-3">
        <label>Hours Range:</label>
            <div id="rangeSlider"></div>
        <span id="rangeValues"></span>
    </div>

</div>

<div class="container-fluid mt-3 shadow-sm p-4 mb-5 bg-white rounded-4 border-1 border">
        <div class="row">
            <h2 class="text-start">Kneader Parameters (Real Time) <i class="bi bi-clock"></i></h2>
            <div class="text-end mb-2">
                <small id="lastUpdate" class="text-muted">Last update: --</small>
            </div>
        </div>
    <hr class="border border-dark border-0 mb-4 opacity-100">
    <div id="latestCards" class="row mt-4">
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Pressure</div>
                <div class="card-body">
                    <h5 id="pressureValue" class="card-title">-- bar</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Power</div>
                <div class="card-body">
                    <h5 id="powerValue" class="card-title">-- kW</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-black mb-3">
                <div class="card-header">Revolution</div>
                <div class="card-body">
                    <h5 id="revolutionValue" class="card-title">-- rpm</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header">Temperature</div>
                <div class="card-body">
                    <h5 id="temperatureValue" class="card-title">-- °C</h5>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- noUiSlider -->
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet" />

    <script>
        var ctx = document.getElementById('kneaderChart').getContext('2d');
        var allData = [];
        var kneaderChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Pressure', data: [], borderColor: 'rgba(248, 195, 40, 1)', fill: false },
                    { label: 'Power', data: [], borderColor: 'rgba(54, 162, 235, 1)', fill: false },
                    { label: 'Revolution', data: [], borderColor: 'rgba(0, 0, 0, 1)', fill: false },
                    { label: 'Temperature', data: [], borderColor: 'rgba(211, 63, 73, 1)', fill: false }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'category',
                        title: { display: true, text: 'Hora' }
                    }
                }
            }
        });

        // 👉 Función para aplicar rango
        function applyRange(start, end) {
            let sliced = allData.slice(start, end);

            kneaderChart.data.labels = sliced.map(x => {
                let hora = x.time.substring(0,5);
                return hora;
            });

            kneaderChart.data.datasets[0].data = sliced.map(x => parseFloat(x.pressure) || 0);
            kneaderChart.data.datasets[1].data = sliced.map(x => parseFloat(x.power) || 0);
            kneaderChart.data.datasets[2].data = sliced.map(x => parseFloat(x.revolution) || 0);
            kneaderChart.data.datasets[3].data = sliced.map(x => parseFloat(x.temperature) || 0);

            kneaderChart.update();
        }


        // 👉 Inicializar slider doble
        var rangeSlider = document.getElementById('rangeSlider');
        noUiSlider.create(rangeSlider, {
            start: [0, 100], // valores iniciales
            connect: true,
            range: { min: 0, max: 100 }, // se ajustará dinámicamente
            step: 1
        });

        rangeSlider.noUiSlider.on('update', function(values) {
            let start = Math.round(values[0]);
            let end = Math.round(values[1]);
            document.getElementById("rangeValues").innerText = start + " - " + end;
            applyRange(start, end);
        });

        // 👉 Cargar datos vía AJAX
        function loadData(fecha, kneaderId, turno) {
            $("#spinner").show();
            $.getJSON('/Kneader/GetData', { fecha: fecha, kneader: kneaderId, turno: turno })
                .done(function (data) {
                    allData = data;

                    // Ajustar rango máximo según cantidad de registros
                    rangeSlider.noUiSlider.updateOptions({
                        range: { min: 0, max: allData.length },
                        start: [0, allData.length]
                    });

                    applyRange(0, allData.length);

                    // Actualizar tarjetas
                    if (data.length > 0) {
                        let last = data[data.length - 1];
                        $("#pressureValue").text(last.pressure + " bar");
                        $("#powerValue").text(last.power + " kW");
                        $("#revolutionValue").text(last.revolution + " rpm");
                        $("#temperatureValue").text(last.temperature + " °C");
                    } else {
                        $("#pressureValue").text("-- bar");
                        $("#powerValue").text("-- kW");
                        $("#revolutionValue").text("-- rpm");
                        $("#temperatureValue").text("-- °C");
                    }
                })
                .always(function () {
                    $("#spinner").hide();
                });
        }

        function refreshLatestCards(kneaderId) {
            $.getJSON('/Kneader/GetLatest', { kneader: kneaderId })
                .done(function (last) {
                    if (last) {
                        $("#pressureValue").text(last.pressure + " bar");
                        $("#powerValue").text(last.power + " kW");
                        $("#revolutionValue").text(last.revolution + " rpm");
                        $("#temperatureValue").text(last.temperature + " °C");

                        // 👉 Actualizar indicador de última actualización
                        let now = new Date();
                        let hora = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        $("#lastUpdate").text("Last update: " + hora);
                    }
                });
        }


        setInterval(() => {
            let kneader = document.getElementById("kneaderSelect").value;
            refreshLatestCards(kneader);
        }, 10000);


        // Inicializar con datos de hoy y Kneader1
        var today = new Date().toISOString().substring(0,10);
        document.getElementById("startDate").value = today;
        loadData(today, "Kneader1", "Turno1");

        // Evento para el botón
        document.getElementById("applyFilter").addEventListener("click", function() {
            var fecha = document.getElementById("startDate").value;
            var kneader = document.getElementById("kneaderSelect").value;
            var turno = document.getElementById("shiftSelect").value;

            if (!fecha) {
                alert("Debes seleccionar una fecha.");
                return;
            }

            if (turno === "Turno3") {
                let fechaObj = new Date(fecha);
                let siguienteDia = new Date(fechaObj);
                siguienteDia.setDate(fechaObj.getDate() + 1);
                fecha = siguienteDia.toISOString().substring(0, 10);
            }

            loadData(fecha, kneader, turno);
        });
    </script>
}