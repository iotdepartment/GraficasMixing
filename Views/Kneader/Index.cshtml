@model IEnumerable<GraficasMixing.Models.KneaderM>

<div class="container-fluid mt-3 shadow-lg p-4 mb-5 bg-white rounded-3">
    <h2>Kneader Charts (Mixing Area)</h2>
    <hr class="border border-dark border-3 mb-4 opacity-100">

    <!-- Dropdown Kneader -->
    <div style="margin-bottom:20px;">
    <label for="kneaderSelect">Kneader:</label>
    <select id="kneaderSelect" class="form-select" style="width:200px; margin-bottom:20px; display:inline-block;">
        <option value="Kneader1" selected>Kneader1</option>
        <option value="Kneader2">Kneader2</option>
        <option value="Kneader3">Kneader3</option>
    </select>
    </div>
    <!-- Dropdown Turno -->
    <div style="margin-bottom:20px;">
    <label for="shiftSelect">Turno:</label>
    <select id="shiftSelect" class="form-select" style="width:200px; margin-bottom:20px; display:inline-block;">
        <option value="Turno1" selected>Turno 1 (7:00 - 15:00)</option>
        <option value="Turno2">Turno 2 (15:00 - 24:00)</option>
        <option value="Turno3">Turno 3 (00:00 - 7:00)</option>
    </select>
    </div>
    <!-- Selección de una sola fecha -->
    <div style="margin-bottom:20px;">
        <label for="startDate">Fecha:</label>
        <input type="date" id="startDate" class="form-control" style="width:200px; display:inline-block;">

        <!-- Botón para ejecutar el filtro -->
        <button id="applyFilter" class="btn btn-primary" style="margin-left:15px;">Aplicar filtro</button>
        <span id="spinner" class="spinner-border spinner-border-sm me-2" style="display:none;"></span>
    </div>

    <div style="overflow-x:auto; width: 100%;">
        <canvas id="kneaderChart" width="1500" height="300"></canvas>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Inicializar gráfico vacío
        var ctx = document.getElementById('kneaderChart').getContext('2d');
        var kneaderChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Pressure', data: [], borderColor: 'rgba(255, 99, 132, 1)', fill: false },
                    { label: 'Power', data: [], borderColor: 'rgba(54, 162, 235, 1)', fill: false },
                    { label: 'Revolution', data: [], borderColor: 'rgba(255, 206, 86, 1)', fill: false },
                    { label: 'Temperature', data: [], borderColor: 'rgba(75, 192, 192, 1)', fill: false }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                let value = context.raw;
                                if (label === 'Pressure') return label + ': ' + value + ' bar';
                                if (label === 'Power') return label + ': ' + value + ' kW';
                                if (label === 'Revolution') return label + ': ' + value + ' rpm';
                                if (label === 'Temperature') return label + ': ' + value + ' °C';
                                return label + ': ' + value;
                            }
                        }
                    }
                }
            }
        });

        // Función para cargar datos vía AJAX
        function loadData(fecha, kneaderId, turno) {
            $("#spinner").show();
            $.getJSON('/Kneader/GetData', { fecha: fecha, kneader: kneaderId, turno: turno })
                .done(function (data) {
                    kneaderChart.data.labels = data.map(x => x.date.substring(0,10) + " " + x.time);
                    kneaderChart.data.datasets[0].data = data.map(x => parseFloat(x.pressure) || 0);
                    kneaderChart.data.datasets[1].data = data.map(x => parseFloat(x.power) || 0);
                    kneaderChart.data.datasets[2].data = data.map(x => parseFloat(x.revolution) || 0);
                    kneaderChart.data.datasets[3].data = data.map(x => parseFloat(x.temperature) || 0);
                    kneaderChart.update();
                })
                .always(function () {
                    $("#spinner").hide();
                });
        }

        // Inicializar con datos de hoy y Kneader1
        var today = new Date().toISOString().substring(0,10);
        document.getElementById("startDate").value = today;
        loadData(today, "Kneader1", "Turno1");

        // Evento para el botón
        document.getElementById("applyFilter").addEventListener("click", function() {
            var fecha = document.getElementById("startDate").value;
            var kneader = document.getElementById("kneaderSelect").value;
            var turno = document.getElementById("shiftSelect").value;

            if (!fecha) {
                alert("Debes seleccionar una fecha.");
                return;
            }

            // Ajuste automático para Turno 3 → usar el día siguiente
            if (turno === "Turno3") {
                let fechaObj = new Date(fecha);
                let siguienteDia = new Date(fechaObj);
                siguienteDia.setDate(fechaObj.getDate() + 1);
                fecha = siguienteDia.toISOString().substring(0, 10);
            }

            loadData(fecha, kneader, turno);
        });
    </script>
}