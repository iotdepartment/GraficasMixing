@model IEnumerable<GraficasMixing.Models.KneaderM>
@{
    ViewData["Title"] = "Home Page";
}
@if (Model != null && Model.Any())
{
    <div class="container-fluid mt-3 shadow-lg p-4 mb-5 bg-white rounded-3">
        <div class="row mb-4">
            <h2>Graficas Mixing</h2>
            <hr class="border border-dark border-3 mb-4 opacity-100">
        </div>
        <div class="row mb-4">
            <!-- Dropdown para seleccionar el Kneader -->
            <select id="kneaderSelect" class="form-select" style="width:200px; margin-bottom:20px;">
                @foreach (var kneader in Model.Select(m => m.Kneader).Distinct())
                {
                    <option value="@kneader">@kneader</option>
                }
            </select>

            <!-- Inputs para rango de fechas -->
            <div style="margin-bottom:20px;">
                <label for="startDate">Fecha inicio:</label>
                <input type="date" id="startDate" class="form-control" style="width:200px; display:inline-block;">

                <label for="endDate" style="margin-left:10px;">Fecha fin:</label>
                <input type="date" id="endDate" class="form-control" style="width:200px; display:inline-block;">
            </div>

            <canvas id="kneaderChart" width="600" height="200"></canvas>
        </div>
    </div>
}
else
{
    <p>No hay datos disponibles para graficar.</p>
}

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Serializar todos los datos desde Razor
        var allData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));

        // Función para filtrar por Kneader y rango de fechas
        function filterByKneader(kneaderId) {
            var startDate = document.getElementById("startDate").value;
            var endDate = document.getElementById("endDate").value;

            var filtered = allData.filter(x => {
                if (x.Kneader !== kneaderId) return false;

                // Convertir a objeto Date (asegúrate que x.Date sea ISO o compatible)
                var recordDate = new Date(x.Date);

                // Si no hay rango definido, aceptar todo
                if (!startDate || !endDate) return true;

                var start = new Date(startDate);
                var end = new Date(endDate);

                // Comparar solo por día (ignorar horas)
                return recordDate >= start && recordDate <= end;
            });

            kneaderChart.data.labels = filtered.map(x => x.Date.substring(0,10) + " " + x.Time);
            kneaderChart.data.datasets[0].data = filtered.map(x => parseFloat(x.Pressure) || 0);
            kneaderChart.data.datasets[1].data = filtered.map(x => parseFloat(x.Power) || 0);
            kneaderChart.data.datasets[2].data = filtered.map(x => parseFloat(x.Revolution) || 0);
            kneaderChart.data.datasets[3].data = filtered.map(x => parseFloat(x.Temperature) || 0);

            kneaderChart.options.plugins.title.text = kneaderId + " Parameters chart";
            kneaderChart.update();
        }

        // Inicializar gráfico
        var ctx = document.getElementById('kneaderChart').getContext('2d');
        var kneaderChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Pressure', data: [], borderColor: 'rgba(255, 99, 132, 1)', fill: false, tension: 0.3, pointRadius: 2 },
                    { label: 'Power', data: [], borderColor: 'rgba(54, 162, 235, 1)', fill: false, tension: 0.3, pointRadius: 2 },
                    { label: 'Revolution', data: [], borderColor: 'rgba(255, 206, 86, 1)', fill: false, tension: 0.3, pointRadius: 2 },
                    { label: 'Temperature', data: [], borderColor: 'rgba(75, 192, 192, 1)', fill: false, tension: 0.3, pointRadius: 2 }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    title: { display: true, text: 'Kneader Parameters chart' },
                    legend: { position: 'bottom' }
                },
                scales: { y: { beginAtZero: true } }
            }
        });

        // Inicializar con el primer Kneader del dropdown
        filterByKneader(document.getElementById("kneaderSelect").value);

        // Eventos al cambiar dropdown o rango de fechas
        document.getElementById("kneaderSelect").addEventListener("change", function() {
            filterByKneader(this.value);
        });
        document.getElementById("startDate").addEventListener("change", function() {
            filterByKneader(document.getElementById("kneaderSelect").value);
        });
        document.getElementById("endDate").addEventListener("change", function() {
            filterByKneader(document.getElementById("kneaderSelect").value);
        });
    </script>
}