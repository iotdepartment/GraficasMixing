@model IEnumerable<GraficasMixing.Models.KneaderM>

<div class="container-fluid mt-3 shadow-lg p-4 mb-5 bg-white rounded-3">
    <h2>Graficas Kneader (Área de Mixing)</h2>
    <hr class="border border-dark border-3 mb-4 opacity-100">

    <!-- Dropdown Kneader -->
    <select id="kneaderSelect" class="form-select" style="width:200px; margin-bottom:20px;">
        <option value="Kneader1" selected>Kneader1</option>
        <option value="Kneader2">Kneader2</option>
        <option value="Kneader3">Kneader3</option>
    </select>

    <!-- Dropdown Turno -->
    <select id="shiftSelect" class="form-select" style="width:200px; margin-bottom:20px;">
        <option value="Turno1" selected>Turno 1 (7:00 - 14:00)</option>
        <option value="Turno2">Turno 2 (14:00 - 24:00)</option>
        <option value="Turno3">Turno 3 (24:00 - 7:00)</option>
    </select>

    <!-- Filtro por rango de fechas -->
    <div style="margin-bottom:20px;">
        <label for="startDate">Fecha inicio:</label>
        <input type="date" id="startDate" class="form-control" style="width:200px; display:inline-block;">
        <label for="endDate" style="margin-left:10px;">Fecha fin:</label>
        <input type="date" id="endDate" class="form-control" style="width:200px; display:inline-block;">

        <!-- Botón para ejecutar el filtro -->
        <button id="applyFilter" class="btn btn-primary" style="margin-left:15px;">Aplicar filtro</button>
        <span id="spinner" class="spinner-border spinner-border-sm me-2" style="display:none;"></span>
    </div>

    <div style="overflow-x:auto; width: 100%;">
        <canvas id="kneaderChart" width="1500" height="300"></canvas>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Inicializar gráfico vacío
        var ctx = document.getElementById('kneaderChart').getContext('2d');
        var kneaderChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Pressure', data: [], borderColor: 'rgba(255, 99, 132, 1)', fill: false },
                    { label: 'Power', data: [], borderColor: 'rgba(54, 162, 235, 1)', fill: false },
                    { label: 'Revolution', data: [], borderColor: 'rgba(255, 206, 86, 1)', fill: false },
                    { label: 'Temperature', data: [], borderColor: 'rgba(75, 192, 192, 1)', fill: false }
                ]
            },

            options: {
                responsive: true,
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            stepSize: 30,
                            displayFormats: {
                                minute: 'HH:mm'
                            }
                        },
                        ticks: {
                            autoSkip: true,
                            maxRotation: 0,
                            minRotation: 0
                        }
                    },

                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                let value = context.raw;
                                if (label === 'Pressure') return label + ': ' + value + ' bar';
                                if (label === 'Power') return label + ': ' + value + ' kW';
                                if (label === 'Revolution') return label + ': ' + value + ' rpm';
                                if (label === 'Temperature') return label + ': ' + value + ' °C';
                                return label + ': ' + value;
                            }
                        }
                    }
                }
            }
        });

        // Función para cargar datos vía AJAX
        function loadData(fechaInicio, fechaFin, kneaderId, turno) {
            $("#spinner").show();
            $.getJSON('/Kneader/GetData', { fechaInicio: fechaInicio, fechaFin: fechaFin, kneader: kneaderId, turno: turno })
                .done(function (data) {
                    kneaderChart.data.labels = data.map(x => x.date.substring(0,10) + " " + x.time);
                    kneaderChart.data.datasets[0].data = data.map(x => parseFloat(x.pressure) || 0);
                    kneaderChart.data.datasets[1].data = data.map(x => parseFloat(x.power) || 0);
                    kneaderChart.data.datasets[2].data = data.map(x => parseFloat(x.revolution) || 0);
                    kneaderChart.data.datasets[3].data = data.map(x => parseFloat(x.temperature) || 0);
                    kneaderChart.update();
                })
                .always(function () {
                    $("#spinner").hide();
                });
        }

        // Inicializar con datos de hoy y Kneader1
        var today = new Date().toISOString().substring(0,10);
        document.getElementById("startDate").value = today;
        document.getElementById("endDate").value = today;
        loadData(today, today, "Kneader1", "Turno1");

        // Evento único para el botón
        document.getElementById("applyFilter").addEventListener("click", function() {
            var start = document.getElementById("startDate").value;
            var end = document.getElementById("endDate").value;
            var kneader = document.getElementById("kneaderSelect").value;
            var turno = document.getElementById("shiftSelect").value;

            if (start > end) {
                alert("La fecha inicio no puede ser mayor que la fecha fin.");
                return;
            }

            loadData(start, end, kneader, turno);
        });
    </script>
}