@model IEnumerable<GraficasMixing.Models.KneaderM>

<div class="container-fluid mt-3 shadow-lg p-4 mb-5 bg-white rounded-3">
    <h2>Graficas Mixing</h2>
    <hr class="border border-dark border-3 mb-4 opacity-100">

    <!-- Dropdown Kneader -->
    <select id="kneaderSelect" class="form-select" style="width:200px; margin-bottom:20px;">
        <option value="Kneader1" selected>Kneader1</option>
        <option value="Kneader2">Kneader2</option>
        <option value="Kneader3">Kneader3</option>
    </select>

    <!-- Filtro por rango de fechas -->
    <div style="margin-bottom:20px;">
        <label for="startDate">Fecha inicio:</label>
        <input type="date" id="startDate" class="form-control" style="width:200px; display:inline-block;">
        <label for="endDate" style="margin-left:10px;">Fecha fin:</label>
        <input type="date" id="endDate" class="form-control" style="width:200px; display:inline-block;">
    </div>

    <canvas id="kneaderChart" width="600" height="200"></canvas>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Inicializar gráfico vacío
        var ctx = document.getElementById('kneaderChart').getContext('2d');
        var kneaderChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Pressure', data: [], borderColor: 'rgba(255, 99, 132, 1)', fill: false },
                    { label: 'Power', data: [], borderColor: 'rgba(54, 162, 235, 1)', fill: false },
                    { label: 'Revolution', data: [], borderColor: 'rgba(255, 206, 86, 1)', fill: false },
                    { label: 'Temperature', data: [], borderColor: 'rgba(75, 192, 192, 1)', fill: false }
                ]
            },
            options: { responsive: true }
        });

        // Función para cargar datos vía AJAX
        function loadData(fechaInicio, fechaFin, kneaderId) {
            $.getJSON('/Kneader/GetData', { fechaInicio: fechaInicio, fechaFin: fechaFin, kneader: kneaderId }, function (data) {
                kneaderChart.data.labels = data.map(x => x.date.substring(0,10) + " " + x.time);
                kneaderChart.data.datasets[0].data = data.map(x => parseFloat(x.pressure) || 0);
                kneaderChart.data.datasets[1].data = data.map(x => parseFloat(x.power) || 0);
                kneaderChart.data.datasets[2].data = data.map(x => parseFloat(x.revolution) || 0);
                kneaderChart.data.datasets[3].data = data.map(x => parseFloat(x.temperature) || 0);
                kneaderChart.update();
            });
        }

        // Inicializar con datos de hoy y Kneader1
        var today = new Date().toISOString().substring(0,10);
        document.getElementById("startDate").value = today;
        document.getElementById("endDate").value = today;
        loadData(today, today, "Kneader1");

        // Eventos
        document.getElementById("kneaderSelect").addEventListener("change", function() {
            loadData(document.getElementById("startDate").value, document.getElementById("endDate").value, this.value);
        });
        document.getElementById("startDate").addEventListener("change", function() {
            loadData(this.value, document.getElementById("endDate").value, document.getElementById("kneaderSelect").value);
        });
        document.getElementById("endDate").addEventListener("change", function() {
            loadData(document.getElementById("startDate").value, this.value, document.getElementById("kneaderSelect").value);
        });
    </script>
}